# Chapter: Nav2 for Humanoids - Navigation Foundation
**Module**: Module 3: AI-Robot Brain (NVIDIA Isaac)
**Week**: Week 7-8
**Complexity**: Deep Technical
**Target Hardware**: Both

## Learning Objectives
- Configure Nav2 stack for bipedal humanoid navigation
- Implement custom planners for non-holonomic humanoid movement
- Set up costmaps for humanoid-specific navigation constraints
- Create navigation behaviors for stair climbing and obstacle avoidance
- Integrate navigation with perception and control systems

## Prerequisites
- VSLAM pipeline from M3C2
- ROS 2 communication from M1C1
- Basic understanding of path planning algorithms

## Content Structure
### 1. Concept (Theory)
Navigation 2 (Nav2) is ROS 2's navigation stack that provides path planning, obstacle avoidance, and localization for mobile robots. For humanoid robots, special considerations include:
- Non-holonomic constraints (limited movement directions)
- Balance requirements during navigation
- Step planning for stair climbing
- Dynamic obstacle avoidance for safety

The Nav2 architecture includes:
- Global planner (path planning)
- Local planner (collision avoidance)
- Costmap layers (environment representation)
- Controller (trajectory following)

### 2. Simulator Implementation
Configure Nav2 for humanoid navigation:

<Tabs>
<TabItem value="simulation" label="Simulation Setup">

```yaml
# humanoid_nav2_config.yaml
amcl:
  ros__parameters:
    use_sim_time: True
    alpha1: 0.2
    alpha2: 0.2
    alpha3: 0.2
    alpha4: 0.2
    alpha5: 0.2
    base_frame_id: "base_link"
    beam_skip_distance: 0.5
    beam_skip_error_threshold: 0.9
    beam_skip_threshold: 0.3
    do_beamskip: false
    global_frame_id: "map"
    lambda_short: 0.1
    laser_likelihood_max_dist: 2.0
    laser_max_range: 10.0
    laser_min_range: -1.0
    laser_model_type: "likelihood_field"
    max_beams: 60
    max_particles: 2000
    min_particles: 500
    odom_frame_id: "odom"
    pf_err: 0.05
    pf_z: 0.99
    recovery_alpha_fast: 0.0
    recovery_alpha_slow: 0.0
    resample_interval: 1
    robot_model_type: "nav2_amcl::DifferentialMotionModel"
    save_pose_rate: 0.5
    sigma_hit: 0.2
    tf_broadcast: true
    transform_tolerance: 1.0
    update_min_a: 0.2
    update_min_d: 0.25
    z_hit: 0.5
    z_max: 0.05
    z_rand: 0.5
    z_short: 0.05

amcl_map_client:
  ros__parameters:
    use_sim_time: True

amcl_rclcpp_node:
  ros__parameters:
    use_sim_time: True

bt_navigator:
  ros__parameters:
    use_sim_time: True
    global_frame: map
    robot_base_frame: base_link
    odom_topic: /odom
    bt_loop_duration: 10
    default_server_timeout: 20
    enable_groot_monitoring: True
    groot_zmq_publisher_port: 1666
    groot_zmq_server_port: 1667
    # Specify the custom behavior tree for humanoid navigation
    default_nav_to_pose_bt_xml: "humanoid_nav_to_pose_w_replanning_and_recovery.xml"
    default_nav_through_poses_bt_xml: "humanoid_nav_through_poses_w_replanning_and_recovery.xml"

bt_navigator_rclcpp_node:
  ros__parameters:
    use_sim_time: True

controller_server:
  ros__parameters:
    use_sim_time: True
    controller_frequency: 20.0
    min_x_velocity_threshold: 0.001
    min_y_velocity_threshold: 0.5
    min_theta_velocity_threshold: 0.001
    # Use custom humanoid controller
    progress_checker_plugin: "progress_checker"
    goal_checker_plugin: "goal_checker"
    controller_plugins: ["FollowPath"]

    # Humanoid controller
    FollowPath:
      plugin: "nav2_mppi_controller::Controller"
      time_steps: 24
      control_freq: 20
      horizon: 1.5
      dt: 0.05
      # Humanoid-specific parameters
      v_max: 0.3  # Lower speed for stability
      v_min: -0.1
      omega_max: 0.5
      omega_min: -0.5
      acc_max: 0.5
      acc_min: -0.5
      kappa_max: 1.0
      reference_speed: 0.2
      # Cost function weights for humanoid stability
      vx_scale: 1.0
      vy_scale: 0.0
      omega_scale: 0.5
      replan_on_exception: True

    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"
      required_movement_radius: 0.5
      movement_time_allowance: 10.0

    goal_checker:
      plugin: "nav2_controller::SimpleGoalChecker"
      xy_goal_tolerance: 0.25
      yaw_goal_tolerance: 0.25
      stateful: True

local_costmap:
  local_costmap:
    ros__parameters:
      update_frequency: 5.0
      publish_frequency: 2.0
      global_frame: odom
      robot_base_frame: base_link
      use_sim_time: True
      rolling_window: true
      width: 6
      height: 6
      resolution: 0.05
      # Humanoid-specific inflation for stability margin
      plugins: ["voxel_layer", "inflation_layer"]
      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        cost_scaling_factor: 3.0
        inflation_radius: 0.8  # Larger for humanoid stability
      voxel_layer:
        plugin: "nav2_costmap_2d::VoxelLayer"
        enabled: True
        publish_voxel_map: True
        origin_z: 0.0
        z_resolution: 0.2
        z_voxels: 8
        max_obstacle_height: 2.0
        mark_threshold: 0
        observation_sources: scan
        scan:
          topic: /scan
          max_obstacle_height: 2.0
          clearing: True
          marking: True
          data_type: "LaserScan"
          raytrace_max_range: 3.0
          raytrace_min_range: 0.0
          obstacle_max_range: 2.5
          obstacle_min_range: 0.0

global_costmap:
  global_costmap:
    ros__parameters:
      update_frequency: 1.0
      publish_frequency: 1.0
      global_frame: map
      robot_base_frame: base_link
      use_sim_time: True
      robot_radius: 0.4  # Larger for humanoid safety
      resolution: 0.05
      plugins: ["static_layer", "obstacle_layer", "inflation_layer"]
      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        enabled: True
        observation_sources: scan
        scan:
          topic: /scan
          max_obstacle_height: 2.0
          clearing: True
          marking: True
          data_type: "LaserScan"
          raytrace_max_range: 3.0
          raytrace_min_range: 0.0
          obstacle_max_range: 2.5
          obstacle_min_range: 0.0
      static_layer:
        plugin: "nav2_costmap_2d::StaticLayer"
        map_subscribe_transient_local: True
      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        cost_scaling_factor: 3.0
        inflation_radius: 0.8

planner_server:
  ros__parameters:
    expected_planner_frequency: 20.0
    # Use custom planner for humanoid movement
    planner_plugins: ["GridBased"]
    GridBased:
      # For humanoid, we might want to use a custom planner plugin
      plugin: "nav2_navfn_planner::NavfnPlanner"
      tolerance: 0.5
      use_astar: false
      allow_unknown: true
```

Launch file for humanoid Nav2:
```xml
<!-- humanoid_nav2.launch.py -->
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument, SetEnvironmentVariable
from launch.substitutions import LaunchConfiguration
from launch_ros.actions import Node
from nav2_common.launch import RewrittenYaml
import os

def generate_launch_description():
    # Parameters
    use_sim_time = LaunchConfiguration('use_sim_time')
    params_file = LaunchConfiguration('params_file')
    autostart = LaunchConfiguration('autostart')
    use_composition = LaunchConfiguration('use_composition')

    # Create the launch configuration
    param_substitutions = {
        'use_sim_time': use_sim_time,
        'autostart': autostart
    }

    configured_params = RewrittenYaml(
        source_file=params_file,
        root_key='',
        param_rewrites=param_substitutions,
        convert_types=True
    )

    # Nav2 components
    lifecycle_manager = Node(
        package='nav2_lifecycle_manager',
        executable='lifecycle_manager',
        name='lifecycle_manager',
        output='screen',
        parameters=[{'use_sim_time': use_sim_time},
                   {'autostart': autostart},
                   {'node_names': ['map_server',
                                  'planner_server',
                                  'controller_server',
                                  'bt_navigator',
                                  'amcl']}]
    )

    # Planner server
    planner_server = Node(
        package='nav2_planner',
        executable='planner_server',
        name='planner_server',
        output='screen',
        parameters=[configured_params]
    )

    # Controller server
    controller_server = Node(
        package='nav2_controller',
        executable='controller_server',
        name='controller_server',
        output='screen',
        parameters=[configured_params]
    )

    # BT Navigator
    bt_navigator = Node(
        package='nav2_bt_navigator',
        executable='bt_navigator',
        name='bt_navigator',
        output='screen',
        parameters=[configured_params]
    )

    # Local costmap
    local_costmap = Node(
        package='nav2_costmap_2d',
        executable='nav2_costmap_2d',
        name='local_costmap',
        output='screen',
        parameters=[configured_params]
    )

    # Global costmap
    global_costmap = Node(
        package='nav2_costmap_2d',
        executable='nav2_costmap_2d',
        name='global_costmap',
        output='screen',
        parameters=[configured_params]
    )

    return LaunchDescription([
        lifecycle_manager,
        planner_server,
        controller_server,
        bt_navigator,
        local_costmap,
        global_costmap
    ])
```

**Hardware Reality Check**: Runs on Simulation (RTX PC)

**Dependencies**:
```xml
<!-- package.xml -->
<?xml version="1.0"?>
<?xml-model href="http://download.ros.org/schema/package_format3.xsd" schematypens="http://www.w3.org/2001/XMLSchema"?>
<package format="3">
  <name>humanoid_nav2_config</name>
  <version>0.1.0</version>
  <description>Nav2 configuration for humanoid robot navigation</description>
  <maintainer email="user@todo.todo">user</maintainer>
  <license>Apache-2.0</license>

  <depend>nav2_common</depend>
  <depend>nav2_map_server</depend>
  <depend>nav2_planner</depend>
  <depend>nav2_controller</depend>
  <depend>nav2_bt_navigator</depend>
  <depend>nav2_lifecycle_manager</depend>
  <depend>nav2_amcl</depend>
  <depend>nav2_costmap_2d</depend>
  <depend>nav2_util</depend>
  <depend>nav2_voxel_grid</depend>

  <export>
    <build_type>ament_cmake</build_type>
  </export>
</package>
```

</TabItem>
</Tabs>

### 3. Edge Deployment Strategy
Deploy Nav2 on NVIDIA Jetson for humanoid navigation:

<Tabs>
<TabItem value="edge" label="Edge Deployment">

```bash
# Launch Nav2 optimized for Jetson
# Adjust parameters for computational constraints
ros2 launch humanoid_nav2_config humanoid_nav2_jetson.launch.py

# Monitor navigation performance
ros2 run rqt_plot rqt_plot &
ros2 run rviz2 rviz2
```

Optimize for edge constraints:
- Reduce costmap resolution for faster processing
- Use simpler planners for real-time performance
- Implement dynamic parameter reconfiguration
- Add safety behaviors for physical robot protection

**Hardware Reality Check**: Runs on Edge (Jetson)

</TabItem>
</Tabs>

## Visual Verification
```mermaid
graph TD
    A[Global Planner] --> B[Path Planning]
    B --> C[Local Planner]
    C --> D[Obstacle Avoidance]
    D --> E[Controller]
    E --> F[Humanoid Motion]
    F --> G[Odometry Feedback]
    G --> A
    H[Costmap] --> C
    I[Sensor Data] --> H
    J[Localization] --> B
    K[Map] --> J
```

## Exercises and Labs
1. Configure Nav2 for your humanoid robot in simulation
2. Adjust parameters for bipedal movement constraints
3. Test navigation in various simulated environments
4. Implement custom behaviors for humanoid-specific challenges
5. Deploy navigation stack on Jetson hardware

## Troubleshooting
- If navigation fails, check costmap inflation parameters
- For planner issues, verify robot footprint and kinematics
- If controllers are unstable, adjust velocity limits and acceleration
- For localization problems, check sensor configurations and transforms

## Further Reading
- Nav2 documentation and tutorials
- Humanoid robot navigation challenges
- Path planning for non-holonomic systems
- ROS 2 navigation best practices